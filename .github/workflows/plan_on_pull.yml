name: Azure Plan Workflow

on:
  pull_request:
    # will target all branches except the below (only use branches or branches-ignore)
    branches:
      - main
     
    paths:
      # the workflow will only run if the below are changed
      - 'main.tf'

permissions:
  id-token: write
  contents: read

env:
  ARM_CLIENT_ID: "${{ secrets.AZURE_CLIENT_ID }}"
  ARM_SUBSCRIPTION_ID: "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
  ARM_TENANT_ID: "${{ secrets.AZURE_TENANT_ID }}"

jobs:
  terraform-plan-policy-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Terraform install
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init -reconfigure

    - name: Terraform Force Unlock
      run: terraform force-unlock -force eyJJRCI6ImZjNzczMzUxLTUxZTYtY2E2Zi01MmZkLTk0MDcwODA4MjJiMCIsIk9wZXJhdGlvbiI6Ik9wZXJhdGlvblR5cGVQbGFuIiwiSW5mbyI6IiIsIldobyI6InJ1bm5lckBmdi1hejE0MDUtNzc2IiwiVmVyc2lvbiI6IjEuOS44IiwiQ3JlYXRlZCI6IjIwMjQtMTEtMjVUMTI6NTk6MDguODIwMTM3NjU0WiIsIlBhdGgiOiJib2x0c2xhY2tib3QvdGVycmFmb3JtLnRmc3RhdGUifQ==

    - name: Terraform Plan
      run: terraform plan -out "tfplan"

    - name: Convert Terraform Plan to JSON
      run: terraform show -json tfplan | grep '^{.*}$' > tfplan.json

    - name: Setup OPA
      uses: open-policy-agent/setup-opa@v2
      with:
        version: latest

    - name: Run OPA Authz Policy Check
      id: opa-authz-check
      run: |
        result=$(opa eval --data .github/workflows/terraform.rego --input tfplan.json "data.terraform.analysis.authz" --format=json | jq '.result[0].expressions[0].value')
        echo $result
      continue-on-error: false
    
    - name: Run OPA Score Policy Check
      id: opa-score-check
      run: opa eval --data .github/workflows/terraform.rego --input tfplan.json "data.terraform.analysis.score"
      continue-on-error: false


      
